services:
  db:
    image: mariadb:10.5
    platform: linux/amd64
    restart: unless-stopped
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MARIADB_ROOT_PASSWORD: openboxes_root
      MARIADB_DATABASE: openboxes
      MARIADB_USER: openboxes
      MARIADB_PASSWORD: openboxes
    volumes:
      - openboxes_mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - openboxes-network

  openboxes:
    build:
      context: .
      args:
        OPENBOXES_VERSION: ${OPENBOXES_VERSION:-v0.9.6-hotfix1}
    platform: linux/amd64
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - OPENBOXES_URL=${OPENBOXES_URL:-http://localhost:8080}
    volumes:
      - ./openboxes-config.properties:/root/.grails/openboxes-config.properties:ro
    depends_on:
      db:
        condition: service_healthy
    links:
      - db
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    networks:
      - openboxes-network

volumes:
  openboxes_mysql_data:
    driver: local

networks:
  openboxes-network:
    driver: bridge
